# Implementation Summary: Long-Form Compose Syntax & PATH Resolution

## Overview

Successfully implemented long-form Docker Compose syntax for volumes and ports, along with automatic path resolution using `HOST_PATH` and `TAG` environment variables.

## Key Features Implemented

### 1. Volume & Port Transformations

**New File:** `utils/compose_transforms.py`

- **Volume Transformation**: Converts short-form volume syntax to long-form with automatic `${HOST_PATH}` substitution
  - Handles relative paths: `./config:/config` → `${HOST_PATH}/config`
  - Preserves absolute paths: `/data:/data` → `/data`
  - Handles complex cases: `/path:with:colon:/app` ✓
  - Supports mount options: `:ro`, `:rw`, `:rshared`, etc.

- **Port Transformation**: Converts short-form port syntax to long-form
  - Simple: `"8096:8096"` → `{"target": 8096, "published": 8096, "protocol": "tcp"}`
  - With protocol: `"7359:7359/udp"` → includes `"protocol": "udp"`
  - With host IP: `"127.0.0.1:8080:80"` → includes `"host_ip": "127.0.0.1"`

### 2. Environment Variable Generation

**Updated:** `services/compose_generator.py`

- **`.env` File Generation**: Automatic creation of `.env` files for each stack
  ```bash
  # Auto-generated by Mastarr
  # Application: jellyfin
  # Generated: 2025-10-29T10:30:00

  # Host path for this stack - used for volume mounts
  HOST_PATH=/home/user/docker/stacks/jellyfin

  # Docker image tag (defaults to 'latest' if not specified)
  TAG=latest
  ```

- **New Methods**:
  - `generate_env_file()`: Creates `.env` content
  - `write_env_file()`: Writes `.env` to disk
  - `_transform_volumes_to_long_form()`: Transforms all service volumes
  - `_transform_ports_to_long_form()`: Transforms all service ports

### 3. Docker Compose Execution

**Updated:** `services/installer.py`

- Now uses `--project-directory` with host paths (not container paths)
- Automatically loads `.env` from project directory (no explicit `--env-file` needed)
- Generates `.env` file before starting containers

**Command Structure:**
```bash
docker compose \
  --project-directory /host/path/to/stack \
  -f /host/path/to/stack/docker-compose.yml \
  up -d
```

### 4. Advanced Options Support

**Updated:** `models/schemas.py`

- Added `advanced: bool = False` field to `FieldSchema`
- Changed `ServiceSchema` to accept `List[Any]` for volumes/ports (supports both string and dict formats)

**Updated:** `blueprints/jellyfin.json`

- Added `tag` input field (advanced option)
- Marked volume paths as advanced options
- Updated image field to use `${TAG:-latest}` syntax

### 5. Blueprint TAG Support

All blueprints can now use the `TAG` environment variable in their image definitions:

```json
{
  "schema": {
    "image": {
      "default": "jellyfin/jellyfin:${TAG:-latest}",
      "schema": "service.image"
    },
    "tag": {
      "type": "string",
      "label": "Image Tag",
      "default": "latest",
      "advanced": true
    }
  }
}
```

## Benefits

### ✅ No Parsing Ambiguity
- Long-form syntax eliminates issues with colons in paths
- Clear, explicit field definitions

### ✅ Automatic Path Resolution
- `HOST_PATH` variable resolves container vs. host path differences
- Works seamlessly whether Mastarr runs in container or on host

### ✅ Consistent Image Tagging
- Single `TAG` variable for all apps
- Easy version upgrades/rollbacks
- Safe defaults with `${TAG:-latest}`

### ✅ Advanced Options
- Power users can customize paths and tags
- Regular users get sensible defaults
- UI can hide advanced options behind toggle

### ✅ Future-Proof
- Supports all Docker Compose mount options
- Easy to add new transformation logic
- Clean, maintainable code structure

## Example Output

### Generated `docker-compose.yml`:
```yaml
version: '3.9'
services:
  jellyfin:
    image: jellyfin/jellyfin:${TAG:-latest}
    container_name: jellyfin
    restart: unless-stopped
    volumes:
      - type: bind
        source: ${HOST_PATH}/config
        target: /config
      - type: bind
        source: ${HOST_PATH}/cache
        target: /cache
    ports:
      - target: 8096
        published: 8096
        protocol: tcp
    networks:
      - mastarr_net
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=America/New_York
networks:
  mastarr_net:
    external: true
```

### Generated `.env`:
```bash
# Auto-generated by Mastarr
# Application: jellyfin
# Generated: 2025-10-29T10:30:00

# Host path for this stack - used for volume mounts
HOST_PATH=/home/user/docker/stacks/jellyfin

# Docker image tag (defaults to 'latest' if not specified)
TAG=latest
```

## Testing

All transformation functions have been tested and verified:

- ✅ Volume transformations (relative paths, absolute paths, paths with colons)
- ✅ Port transformations (simple, with protocol, with host IP)
- ✅ Long-form input preservation
- ✅ Mount options (ro, rw, propagation)
- ✅ Python syntax validation

## Next Steps

### Phase 2 (Future):
1. Add UI toggle for "Show Advanced Options"
2. Filter blueprint inputs by `advanced` field in frontend
3. Add UI for viewing/editing `.env` files (carefully!)
4. Add backup/restore for `.env` files

## Files Modified

1. **New Files:**
   - `utils/compose_transforms.py` - Transformation functions

2. **Modified Files:**
   - `models/schemas.py` - Added `advanced` field, updated ServiceSchema
   - `services/compose_generator.py` - Added transformations and .env generation
   - `services/installer.py` - Updated to use host paths and generate .env
   - `blueprints/jellyfin.json` - Added TAG field, marked advanced options

## Configuration Notes

- **No explicit `--env-file` flag needed** - Docker Compose automatically loads `.env` from project directory
- **Variable substitution works automatically** - Docker Compose applies substitution when `.env` is in project directory
- **Works on Linux hosts** - Windows support not implemented (by design)
